<!-- run in cmd: python3 -m http.server-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>D3.js World Map</title>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="../vendor/d3-7.6.1/dist/d3.js"></script>
    <style>
        body {
            background-color: #333;
            margin: 0;
            overflow: hidden; /* prevent scrolling */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #my_dataviz {
            width: 80vw;
            height: 80vh;
            display: block;
        }

        #tooltip {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
        }

        #modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }

        #close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #fff;
            background-color: red;
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <!-- Create an element where the map will take place -->
    <svg id="my_dataviz"></svg>
    <div id="tooltip"></div>

    <!-- Modal window for displaying country name -->
    <div id="modal">
        <div id="modal-content">
            <span id="country-name"></span>
            <div id="close-btn">X</div>
        </div>
    </div>

    <script>
        // The svg
        var svg = d3.select("svg"),
            width = window.innerWidth * 0.8,
            height = window.innerHeight * 0.8;

        // Map and projection
        var projection = d3.geoNaturalEarth1()
            .scale((width + 1) / 2 / Math.PI)
            .translate([width / 2, height / 2]);

        // Load external data and boot
        d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function (data) {

            // Extrahiere Daten aus TSV
            d3.tsv("../data/iso3.tsv", d => ({
                alpha3: d.alpha3,
                country: d.country,
                subregion: d.subregion,
                region: d.region
            })).then(function (data) {
                console.log(data);
                // Erstelle ein Objekt, um den Zugriff auf TSV-Daten zu erleichtern
                var tsvDataMap = {};
                data.forEach(function (d) {
                    tsvDataMap[d.country] = d;
                });

            // Draw the map
            var countries = svg.append("g")
                .selectAll("path")
                .data(data.features)
                .enter().append("path")
                .attr("fill", "#ccc")
                .attr("d", d3.geoPath()
                    .projection(projection)
                )
                .style("stroke", "#333")
                .attr("data-properties", function (d) {
                    // Set a custom attribute containing all properties
                    return JSON.stringify(d.properties);
                });

            // Tooltip element for displaying country name
            var tooltip = d3.select("#tooltip");

            // Modal elements
            var modal = d3.select("#modal");
            var modalContent = d3.select("#modal-content");
            var countryName = d3.select("#country-name");
            var closeBtn = d3.select("#close-btn");

            // Variable für das ausgewählte Land
            var selectedCountry;

            // Event listeners for hover
            countries
                .on("mouseover", function (event, d) {
                    var properties = JSON.parse(d3.select(this).attr("data-properties"));
                    if (properties) {
                        // Show tooltip with country name
                        tooltip.text(properties.name)
                            .style("display", "block");
                    } else {
                        tooltip.style("display", "none");
                    }
                    d3.select(this).attr("fill", "orange"); // Change the fill color on hover
                })
                .on("mouseout", function (event, d) {
                    tooltip.style("display", "none");
                    if (!selectedCountry) {
                        d3.select(this).attr("fill", "#ccc"); // Change the fill color back on mouseout
                    }
                })
                .on("click", function (event, d) {
                    var properties = JSON.parse(d3.select(this).attr("data-properties"));
                    if (properties) {
                        // Markiere das aktuell ausgewählte Land
                        selectedCountry = this;
                        d3.select(this).attr("fill", "orange");
                        // Display country name in modal
                        countryName.text(properties.name);
                        // Show modal
                        modal.style("display", "flex");

                        // Display country name in modal
                        countryName.text(properties.name);
                        // Show modal
                        modal.style("display", "flex");
                    }
                });

            // Event listener for closing the modal
            closeBtn.on("click", function () {
                // Hide modal
                modal.style("display", "none");
                // delete country color filling in world map
                d3.select(selectedCountry).attr("fill", "#ccc");
                selectedCountry = null;
            });
        });
    </script>

</body>
</html>
